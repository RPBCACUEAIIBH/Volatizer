#! /bin/bash

# This is a standalone script intended to repair Volatizer if initramfs gets updated, and the modification is lost... (It happened before.)

# Constants
Files="/usr/share/Volatizer"

# Finding roots
ScriptPath="$(cd "$(dirname "$0")"; pwd -P)"
cd $ScriptPath


if [[ $(./volatizer-mode) != "Normal" ]]
then
  echo ""
  echo "This must be executed in Normal mode! Aborting..."
  echo ""
  exit
fi

# Compatibility check (No need to echo anything, CompatibilityCheck.sh does that!)
if ! $Files/Scripts/check-compatibility.sh
then
  exit 1
fi

echo ""
echo "Checking kernel..."
if [[ ! -z $(grep "volatizer" "/etc/kernel/postinst.d/zz-update-grub") && ! -z $(grep "volatizer" "/etc/kernel/postrm.d/zz-update-grub") ]]
then
  echo ""
  echo "No problem detected!"
  echo ""
else
  echo ""
  echo "Can't find Volatizer entry in kernel! This may be due to an update overwriting the modified files. Attempting to repair it..."
  echo ""
  echo "Making changes to kernel"
  "$Files/Scripts/modify-kernel.sh"
  echo ""
  echo "Done!"
  echo ""
fi

echo ""
echo "Checking initramfs..."
if [[ ! -z $(grep "### Volatizer modification starts ###" "/usr/share/initramfs-tools/scripts/local") ]]
then
  echo ""
  echo "No problem detected!"
  echo ""
else
  echo ""
  echo "Can't find Volatizer entry in initramfs! This may be due to an update overwriting the modified file. Attempting to repair it..."
  echo ""
  echo "Making changes to initramfs"
  "$Files/Scripts/modify-initramfs.sh"
  echo ""
  echo "Finalizing modification..."
  update-initramfs -u
  update-grub
  echo ""
  echo "Done!"
  echo ""
fi
